{% extends 'base.html' %}
{% load static %}
{% load mathfilters %}
{% block content_block %}
    <script src="{% static 'js/plugins/sparkline/jquery.sparkline.min.js' %}"></script>
    <script>
        $(document).ready(function () {

            var sparklineCharts = function () {
                $("#AcksPie").sparkline([{{ latest_server_record.delAcks }}, {{ latest_server_record.totalWriteIOsHistVlun}}], {
                    type: 'pie',
                    tooltipFormat: '<span style="color: {{"{{color}"}}}">&#9679;</span> {{"{{offset:offset}"}}} ({{"{{percent.1}"}}}%)',
                    tooltipValueLookups: {
                        'offset': {
                            0: 'Delayed ACKs',
                            1: 'Total IO Requests',
                        },
                    },
                    height: '140',
                    sliceColors: ['#1ab394', '#F5F5F5']
                });

                $("#DedupeUsagePie").sparkline([{{ latest_server_record.ddsSizeUsedTiB|add:"0" }},
                    {{ current_server.capacity_total_sizeTiB|add:"0" }}], {
                    type: 'pie',
                    tooltipFormat: '<span style="color: {{"{{color}"}}}">&#9679;</span> {{"{{offset:offset}"}}} ({{"{{percent.1}"}}}%)',
                    tooltipValueLookups: {
                        'offset': {
                            0: 'Dedupe Size',
                            1: 'Total Capacity',
                        },
                    },
                    height: '140',
                    sliceColors: ['#1ab394', '#F5F5F5']
                });
                var capacitydistribution_values = [{{ current_server.capacity_byType_fc_sizeTiB|add:"0" }}, {{ current_server.capacity_byType_nl_sizeTiB|add:"0" }}, {{  current_server.capacity_byType_ssd_sizeTiB|add:"0" }}]
                $("#CapacityDistributuionPie").sparkline(capacitydistribution_values,
                    {
                        type: 'pie',
                        tooltipFormat: '<span style="color: {{"{{color}"}}}">&#9679;</span> {{"{{offset:offset}"}}} ({{"{{percent.1}"}}}%)',
                        tooltipValueLookups: {
                            'offset': {
                                0: 'FC Size (TiB)',
                                1: 'NL Size (TiB)',
                                2: 'SSD Size (TiB)'
                            },
                        },
                        height: '140',
                        sliceColors: ['#1ab394', '#F5F5F5', '#E0BAD7']
                    });
                var deduplesizeline_values = [{% for record in all_server_records_dedupe_size %}{{ record }}{% if not forloop.last and record != NULL%}, {% endif %}{% endfor %}];
                $("#DedupeSizeLine").sparkline(deduplesizeline_values,
                    {
                        type: 'line',
                        width: '100%',
                        height: '200',
                        lineColor: '#1ab394',
                        fillColor: "#ffffff",
                        tooltipFormat: '{{"Date: {{offset:offset}"}}}<br>Size: {{"{{y}"}}} TiB',
                        tooltipValueLookups: {
                            'offset': {
                {% for date in all_server_records_date %}{{ forloop.counter|sub:'1' }}:
                '{{ date }}'{% if not forloop.last%},
                {% endif %}{% endfor %}
            }
            }
            })
                ;
            };

            var sparkResize;

            $(window).resize(function (e) {
                clearTimeout(sparkResize);
                sparkResize = setTimeout(sparklineCharts, 500);
            });

            sparklineCharts();


        });
    </script>
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h3>{{ company_name }} / Server Details: {{ current_server }}</h3>
                </div>
                <div class="ibox-content">
                    <div class="row">
                        <div class="col-sm-9 m-b-xs">
                            <div data-toggle="buttons" class="btn-group">
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="server-table" class="table table-striped">
                            <thead>
                            <tr>
                                <th>Serial Number</th>
                                <th>Company Name</th>
                                <th>System Model</th>
                                <th>Total Capacity</th>
                                <th>Install Date</th>
                                <th>Dedupe Ratio</th>
                                <th>Kernel version</th>
                                <th>Virtual Volumes</th>
                            </tr>
                            </thead>

                            <tbody>
                            <tr>
                                <td>{{ current_server.serialNumberInserv }}</td>
                                <td>{{ current_server.system_companyName }}</td>
                                <td>{{ current_server.system_model }}</td>
                                <td>{{ current_server.capacity_total_sizeTiB }}</td>
                                <td>{{ current_server.system_installDate }}</td>
                                <td>{{ current_server.capacity_total_dedupeRatio }}</td>
                                <td>{{ latest_server_record.tpdKernelPatch }}</td>
                                <td>{{ latest_server_record.vvCountHistVlun }}</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
            <div class="table-responsive">
                <script type="text/javascript">
                    jQuery(document).ready(function ($) {
                        $(".clickable-row").click(function () {
                            window.location = $(this).data("url");
                        });
                    });
                </script>

            </div>

        </div>
    </div>

    <div class="row">
        <div class="col-lg-3">
            <div class="ibox">
                <div class="ibox-content">
                    <h3>Latest DelAcks</h3>
                    <small>DelayedACKs: {{ latest_server_record.delAcks }}<br>
                        Total IO: {{ latest_server_record.totalWriteIOsHistVlun }}
                    </small>
                    <hr>
                    <div class="text-center">
                        <div id="AcksPie"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3">
            <div class="ibox">
                <div class="ibox-content">
                    <h3>Dedupe Storage Usage</h3>
                    <small>{% if latest_server_record.ddsSizeUsedTiB and current_server.capacity_total_sizeTiB %}Dedupe
                        Size: {{ latest_server_record.ddsSizeUsedTiB }} TiB<br>
                        Total Size: {{ current_server.capacity_total_sizeTiB }} TiB{% else %}No data exists{% endif %}
                    </small>
                    <hr>
                    <div class="text-center">
                        <div id="DedupeUsagePie"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3">
            <div class="ibox">
                <div class="ibox-content">
                    <h3>Total Storage Distribution</h3>
                    <small>Dedupe
                        Size: {{ latest_server_record.ddsSizeUsedTiB }} TiB<br>
                        Total Size: {{ current_server.capacity_total_sizeTiB }} TiB
                    </small>
                    <hr>
                    <div class="text-center">
                        <div id="CapacityDistributuionPie"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox">
                <div class="ibox-content">
                    <h5>Dedupe Size over Time</h5>
                    <hr>
                    <div id="DedupeSizeLine"></div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}